import au.com.dius.pact.provider.junit5.PactVerificationContext;
import au.com.dius.pact.provider.junit5.PactVerificationInvocationContextProvider;
import au.com.dius.pact.provider.junit5.http.HttpTestTarget;
import au.com.dius.pact.provider.junitsupport.Provider;
import au.com.dius.pact.provider.junitsupport.loader.PactFolder;
import org.junit.jupiter.api.TestTemplate;
import org.junit.jupiter.api.extension.ExtendWith;

import java.net.URI;

@Provider("user-service")   // must match the "provider.name" in your pact JSON
@PactFolder("pacts")        // src/test/resources/pacts
public class UserServiceLocalPactVerificationTest {

    // compute provider URI once
    private static final URI PROVIDER_URI = URI.create(
        System.getenv().getOrDefault(
            "PROVIDER_BASE_URL",
            System.getProperty("PROVIDER_BASE_URL", "http://localhost:8080")
        )
    );

    @TestTemplate
    @ExtendWith(PactVerificationInvocationContextProvider.class)
    void verifyPacts(PactVerificationContext context) {
        // Set target here instead of @BeforeEach
        context.setTarget(
            new HttpTestTarget(
                PROVIDER_URI.getHost(),
                resolvePort(PROVIDER_URI),
                basePath(PROVIDER_URI)
            )
        );

        // Run the actual verification
        context.verifyInteraction();
    }

    private static int resolvePort(URI uri) {
        if (uri.getPort() != -1) {
            return uri.getPort();
        }
        return uri.getScheme().equalsIgnoreCase("https") ? 443 : 80;
    }

    private static String basePath(URI uri) {
        String path = uri.getPath();
        return (path == null || path.isEmpty()) ? "/" : path;
    }
}
